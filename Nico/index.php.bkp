<html>
<head>
   <title>Trombi</title>
   <meta charset="utf8">

   <script type="text/javascript">
   		function isFilled(field){
   			return !(field.value == null || field.value == "");
   		}

   		function markError(field, msg){
   			field.style.backgroundColor = "#fba";
   			// Gérer message
   		}

   		function markValid(field){
   			field.style.backgroundColor = "";
   		}

   		function verifField(field){
			msg = "Ce champs doit contenir au moins deux caractères.";

   			if (field.value.length < 2 && isFilled(field)){
   				markError(field, msg);
   				field.testValid = false;
   			}
   			else {
   				markValid(field);
   				field.testValid = true;
   			}
   		}

	   	function verifForm(form)
		{
			var formOk = true;
			var msg	=	"";
			if(!isFilled(form.firstname) && !isFilled(form.lastname)) {
				formOk = false;
				msg	=	"Vous devez remplir au moins un des deux champs.";
			}
			if(formOk){
				formOk = form.firstname.testValid && form.lastname.testValid;
				// msg = "Ce champs doit contenir au moins deux caractères.";
				// if(form.firstname.value.length < 2 && isFilled(form.firstname)){
				// 	markError(form.firstname, msg)
				// 	formOk = false;
				// }
				// if(form.lastname.value.length < 2 && isFilled(form.lastname)){
				// 	markError(form.lastname, msg)
				// 	formOk = false;
				// }
			}
			console.log(formOk);
			return formOk;
		}
   </script>
</head>
<body>

<form name="search" action="" method="POST" onsubmit="return verifForm(this)">
	<label for="lastname">Nom</label>
	<input name="lastname" type="text" onblur="verifField(this)"></input>	

	<label for="firstname">Prénom</label>
	<input name="firstname" type="text" onblur="verifField(this)"></input>	

	<input name="submit" type="submit" value="submit"></input>
</form>
<?php
	$url_bad_picture = "/~sr03p027/common/img/unnamed.png";
	// $photo_url = "https://demeter.utc.fr/portal/pls/portal30/portal30.get_photo_utilisateur_mini";
	if(isset($_POST['submit'])){

		$url = 'https://webapplis.utc.fr/Trombi_ws/mytrombi/result?nom=xx&prenom=xx';
		$ch = curl_init($url);
		curl_setopt($ch, CURLOPT_TIMEOUT, 5);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_NOBODY, true);

		$result = curl_exec($ch);
		curl_close($ch);
		if($result === FALSE) {
			echo 'Service inaccessible</br>';
			exit();	
		}

		$results = json_decode(file_get_contents("https://webapplis.utc.fr/Trombi_ws/mytrombi/result?nom=".$_POST['lastname']."&prenom=".$_POST['firstname']));



		// echo '<pre>';
		// var_dump($tmp);
		// echo '</pre>';
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_TIMEOUT, 5);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		// curl_setopt($ch, CURLOPT_NOBODY, true);

		foreach ($results as $key => $result) {
			// $result->photo = '<img src="https://demeter.utc.fr/portal/pls/portal30/portal30.get_photo_utilisateur_mini?username='.$result->login.'">';
			$url_photo = "https://demeter.utc.fr/portal/pls/portal30/portal30.get_photo_utilisateur_mini?username=$result->login";

			// echo '<pre>';
			// var_dump($tmp);
			// echo '</pre>';
			$result->photo = $url_bad_picture;

			if($result->autorisation == 'O'){
				curl_setopt($ch, CURLOPT_URL, $url_photo);
				$tmp = curl_exec($ch);
				$content_type = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);
	
				if($content_type == 'image/jpeg')		
					$result->photo = $url_photo;

			}
			echo '<img src="'.$result->photo.'">';
			echo '<br/>';
		}
		curl_close($ch);
	}
?>
</body>
</html>
